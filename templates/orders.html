{% extends "base.html" %} {% block title %}Gestor de Pedidos{% endblock %} 

{% block scripts %}
<!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
{{ super() }}
{% endblock %}

{% block content %}
<audio
    id="notification-sound"
    src="{{ url_for('static', filename='audio/notification.mp3') }}"
    preload="auto"
></audio>

<div class="admin-header">
    <div class="container">
        <h1><i class="fas fa-tasks me-2"></i>Gestor de Pedidos</h1>
        <p>Arraste e solte os pedidos ou use o menu para atualizar o status.</p>
    </div>
</div>

<div class="container-fluid my-4">
    <div class="order-board">
        <div class="order-column" id="pending" data-status="pending">
            <h5 class="column-title">
                <i class="fas fa-inbox me-2"></i>A Fazer ({{ pending|length }})
            </h5>
            <div class="column-body">
                {% for order in pending %}
                <div
                    class="order-card"
                    draggable="true"
                    data-order-id="{{ order.id }}"
                >
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <div class="card-customer">
                                {{ order.customer_name }}
                            </div>
                            <div class="card-product">
                                {{ order.crown_name }}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button
                                class="btn btn-sm btn-icon"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li>
                                    <button
                                        class="dropdown-item btn-view-details"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailsModal"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-eye me-2"></i>Ver
                                        Detalhes
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="in_progress"
                                    >
                                        <i class="fas fa-arrow-right me-2"></i
                                        >Avan√ßar Etapa
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-cancel-order text-danger"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-trash-alt me-2"></i
                                        >Cancelar Pedido
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer mt-3">
                        <small>{{ order.order_date|localtime }}</small>
                        <div
                            class="order-timer"
                            data-order-date="{{ order.order_date.isoformat() }}Z"
                        >
                            <i class="fas fa-clock"></i> <span>--:--:--</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="order-column" id="in_progress" data-status="in_progress">
            <h5 class="column-title">
                <i class="fas fa-sync-alt me-2"></i>Em Andamento ({{
                in_progress|length }})
            </h5>
            <div class="column-body">
                {% for order in in_progress %}
                <div
                    class="order-card"
                    draggable="true"
                    data-order-id="{{ order.id }}"
                >
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <div class="card-customer">
                                {{ order.customer_name }}
                            </div>
                            <div class="card-product">
                                {{ order.crown_name }}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button
                                class="btn btn-sm btn-icon"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li>
                                    <button
                                        class="dropdown-item btn-view-details"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailsModal"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-eye me-2"></i>Ver
                                        Detalhes
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="pending"
                                    >
                                        <i class="fas fa-arrow-left me-2"></i
                                        >Retroceder Etapa
                                    </button>
                                </li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="delivered"
                                    >
                                        <i class="fas fa-arrow-right me-2"></i
                                        >Avan√ßar Etapa
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-cancel-order text-danger"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-trash-alt me-2"></i
                                        >Cancelar Pedido
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer mt-3">
                        <small>{{ order.order_date|localtime }}</small>
                        <div
                            class="order-timer"
                            data-order-date="{{ order.order_date.isoformat() }}Z"
                        >
                            <i class="fas fa-clock"></i> <span>--:--:--</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="order-column" id="delivered" data-status="delivered">
            <h5 class="column-title">
                <i class="fas fa-check-circle me-2"></i>Entregues ({{
                delivered|length }})
            </h5>
            <div class="column-body">
                {% for order in delivered %}
                <div
                    class="order-card"
                    draggable="true"
                    data-order-id="{{ order.id }}"
                >
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <div class="card-customer">
                                {{ order.customer_name }}
                            </div>
                            <div class="card-product">
                                {{ order.crown_name }}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button
                                class="btn btn-sm btn-icon"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li>
                                    <button
                                        class="dropdown-item btn-view-details"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailsModal"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-eye me-2"></i>Ver
                                        Detalhes
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="in_progress"
                                    >
                                        <i class="fas fa-arrow-left me-2"></i
                                        >Retroceder Etapa
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-cancel-order text-danger"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-trash-alt me-2"></i
                                        >Cancelar Pedido
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer mt-3">
                        <small>{{ order.order_date|localtime }}</small>
                        <div class="order-timer final-status">
                            <i class="fas fa-check-double"></i>
                            <span>Conclu√≠do</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Detalhes do Pedido
                    <span
                        id="modal-order-id"
                        class="text-primary fw-bold"
                    ></span>
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <div id="modal-loader" class="text-center p-5">
                    <div
                        class="spinner-border text-primary"
                        role="status"
                    ></div>
                </div>
                <div id="modal-content-details" style="display: none">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6><i class="fas fa-user me-2"></i>Cliente</h6>
                            <p class="mb-1">
                                <strong>Nome:</strong>
                                <span id="modal-customer-name"></span>
                            </p>
                            <p class="mb-1">
                                <strong>Telefone:</strong>
                                <span id="modal-customer-phone"></span>
                            </p>
                            <p class="mb-0">
                                <strong>Email:</strong>
                                <span id="modal-customer-email"></span>
                            </p>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h6>
                                <i class="fas fa-shopping-cart me-2"></i>Pedido
                            </h6>
                            <p class="mb-1">
                                <strong>Produto:</strong>
                                <span id="modal-crown-name"></span>
                            </p>
                            <p class="mb-0">
                                <strong>Valor Total:</strong>
                                <span id="modal-total-amount"></span>
                            </p>
                        </div>
                    </div>
                    <hr />
                    <div class="mb-4">
                        <h6><i class="fas fa-cross me-2"></i>Homenagem</h6>
                        <p class="mb-1">
                            <strong>Ente Querido:</strong>
                            <span id="modal-deceased-name"></span>
                        </p>
                        <p class="mb-1">
                            <strong>Mensagem na Faixa:</strong>
                            <span
                                id="modal-custom-message"
                                style="white-space: pre-wrap"
                            ></span>
                        </p>
                    </div>
                    <hr />
                    <div>
                        <h6>
                            <i class="fas fa-map-marker-alt me-2"></i>Entrega
                        </h6>
                        <p class="mb-1">
                            <strong>Local:</strong>
                            <span id="modal-delivery-location"></span>
                        </p>
                        <p class="mb-1">
                            <strong>Capela:</strong>
                            <span id="modal-chapel"></span>
                        </p>
                        <p class="mb-0">
                            <strong>Abertura do Vel√≥rio:</strong>
                            <span id="modal-opening-time"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <small class="text-muted"
                    >Pedido realizado em:
                    <span id="modal-order-date"></span></small
                ><button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const socket = io();
        const notificationSound = document.getElementById("notification-sound");
        let audioUnlocked = false;
        let draggedCard = null;

        // --- L√ìGICA DE TEMPO REAL (SOCKET.IO) ---
        socket.on("connect", () => console.log("Conectado ao servidor!"));
        socket.on("order_created", (order) => {
            if (
                document.querySelector(
                    `.order-card[data-order-id='${order.id}']`,
                )
            )
                return;
            if (audioUnlocked) notificationSound.play();
            addOrderCardToBoard(order);
            showToast(`Novo pedido #${order.id} recebido!`, "info");
        });
        socket.on("order_updated", (data) => {
            const card = document.querySelector(
                `.order-card[data-order-id='${data.order_id}']`,
            );
            if (card) moveCardDOM(card, data.new_status);
        });
        socket.on("order_deleted", (data) => {
            const card = document.querySelector(
                `.order-card[data-order-id='${data.order_id}']`,
            );
            if (card) removeCardDOM(card);
        });

        // --- FUN√á√ïES DE MANIPULA√á√ÉO DA INTERFACE (DOM) ---
        function moveCardDOM(card, newStatus) {
            const sourceColumn = card.closest(".order-column");
            const targetColumn = document.getElementById(newStatus);
            if (!targetColumn || !sourceColumn || sourceColumn.id === newStatus)
                return;

            const targetColumnBody = targetColumn.querySelector(".column-body");

            card.style.opacity = "0";
            setTimeout(() => {
                targetColumnBody.prepend(card);
                updateColumnTitle(sourceColumn.id, -1);
                updateColumnTitle(newStatus, 1);
                updateCardContent(card, newStatus);
                card.style.opacity = "1";
            }, 300);
        }

        function removeCardDOM(card) {
            const columnId = card.closest(".order-column").id;
            card.remove();
            updateColumnTitle(columnId, -1);
        }

        function updateCardContent(card, status) {
            const orderId = card.dataset.orderId;
            const timerDiv = card.querySelector(".order-timer");
            if (status === "delivered") {
                timerDiv.classList.add("final-status");
                timerDiv.innerHTML =
                    '<i class="fas fa-check-double"></i> <span>Conclu√≠do</span>';
            } else {
                timerDiv.classList.remove("final-status");
                timerDiv.innerHTML =
                    '<i class="fas fa-clock"></i> <span>--:--:--</span>';
            }

            const dropdownContainer = card.querySelector(".dropdown");
            let menuItems = `<li><button class="dropdown-item btn-view-details" data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="${orderId}"><i class="fas fa-eye me-2"></i>Ver Detalhes</button></li><li><hr class="dropdown-divider"></li>`;
            if (status === "pending") {
                menuItems += `<li><button class="dropdown-item btn-change-status" data-next-status="in_progress"><i class="fas fa-arrow-right me-2"></i>Avan√ßar Etapa</button></li>`;
            } else if (status === "in_progress") {
                menuItems += `<li><button class="dropdown-item btn-change-status" data-next-status="pending"><i class="fas fa-arrow-left me-2"></i>Retroceder Etapa</button></li><li><button class="dropdown-item btn-change-status" data-next-status="delivered"><i class="fas fa-arrow-right me-2"></i>Avan√ßar Etapa</button></li>`;
            } else if (status === "delivered") {
                menuItems += `<li><button class="dropdown-item btn-change-status" data-next-status="in_progress"><i class="fas fa-arrow-left me-2"></i>Retroceder Etapa</button></li>`;
            }
            menuItems += `<li><hr class="dropdown-divider"></li><li><button class="dropdown-item btn-cancel-order text-danger" data-order-id="${orderId}"><i class="fas fa-trash-alt me-2"></i>Cancelar Pedido</button></li>`;

            dropdownContainer.innerHTML = `<button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button><ul class="dropdown-menu dropdown-menu-dark">${menuItems}</ul>`;

            addEventListenersToCard(card);
            new bootstrap.Dropdown(
                dropdownContainer.querySelector('[data-bs-toggle="dropdown"]'),
            );
        }

        // --- FUN√á√ïES DE COMUNICA√á√ÉO COM O SERVIDOR ---
        function sendStatusUpdate(orderId, newStatus) {
            socket.emit("update_order_status", {
                order_id: orderId,
                new_status: newStatus,
            });
        }
        function sendDeleteOrder(orderId) {
            socket.emit("delete_order", { order_id: orderId });
        }

        // --- FUN√á√ïES DE EVENTOS DO UTILIZADOR ---
        function onChangeStatusClick(e) {
            e.stopPropagation();
            const card = this.closest(".order-card");
            moveCardDOM(card, this.dataset.nextStatus);
            sendStatusUpdate(card.dataset.orderId, this.dataset.nextStatus);
        }

        function onCancelOrderClick(e) {
            e.stopPropagation();
            const card = this.closest(".order-card");
            if (
                confirm(
                    `Tem a certeza de que quer cancelar o Pedido #${card.dataset.orderId}?`,
                )
            ) {
                removeCardDOM(card);
                sendDeleteOrder(card.dataset.orderId);
                showToast(
                    `Pedido #${card.dataset.orderId} foi removido.`,
                    "warning",
                );
            }
        }

        // --- L√ìGICA DE DRAG AND DROP ---
        function onDragStart(event) {
            draggedCard = event.target.closest(".order-card");
            setTimeout(() => draggedCard.classList.add("dragging"), 0);
        }
        function onDragEnd() {
            if (draggedCard) draggedCard.classList.remove("dragging");
            draggedCard = null;
        }
        document.querySelectorAll(".order-column").forEach((column) => {
            column.addEventListener("dragover", (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(
                    column.querySelector(".column-body"),
                    e.clientY,
                );
                if (draggedCard) {
                    if (afterElement == null) {
                        column
                            .querySelector(".column-body")
                            .appendChild(draggedCard);
                    } else {
                        column
                            .querySelector(".column-body")
                            .insertBefore(draggedCard, afterElement);
                    }
                }
            });
            column.addEventListener("drop", (e) => {
                e.preventDefault();
                if (!draggedCard) return;
                const newStatus = column.dataset.status;
                moveCardDOM(draggedCard, newStatus);
                sendStatusUpdate(draggedCard.dataset.orderId, newStatus);
            });
        });

        // --- FUN√á√ïES AUXILIARES E DE INICIALIZA√á√ÉO ---
        function addEventListenersToCard(card) {
            card.addEventListener("dragstart", onDragStart);
            card.addEventListener("dragend", onDragEnd);
            card.querySelectorAll(".btn-change-status").forEach((btn) =>
                btn.addEventListener("click", onChangeStatusClick),
            );
            card.querySelector(".btn-cancel-order")?.addEventListener(
                "click",
                onCancelOrderClick,
            );
        }

        document
            .querySelectorAll(".order-card")
            .forEach((card) => addEventListenersToCard(card));

        const detailsModal = new bootstrap.Modal(
            document.getElementById("orderDetailsModal"),
        );
        document.body.addEventListener("click", function (event) {
            if (event.target.matches(".btn-view-details")) {
                const orderId = event.target.dataset.orderId;
                openDetailsModal(orderId);
            }
        });

        async function openDetailsModal(orderId) {
            const loader = document.getElementById("modal-loader");
            const content = document.getElementById("modal-content-details");
            loader.style.display = "block";
            content.style.display = "none";
            detailsModal.show();
            try {
                const response = await fetch(`/admin/order/details/${orderId}`);
                if (!response.ok) throw new Error("Pedido n√£o encontrado.");
                const data = await response.json();
                document.getElementById("modal-order-id").textContent = data.id;
                document.getElementById("modal-customer-name").textContent =
                    data.customer_name;
                document.getElementById("modal-customer-phone").textContent =
                    data.customer_phone;
                document.getElementById("modal-customer-email").textContent =
                    data.customer_email;
                document.getElementById("modal-crown-name").textContent =
                    data.crown_name;
                document.getElementById("modal-total-amount").textContent =
                    data.total_amount;
                document.getElementById("modal-custom-message").textContent =
                    data.custom_message;
                document.getElementById("modal-deceased-name").textContent =
                    data.deceased_name;
                document.getElementById("modal-delivery-location").textContent =
                    data.delivery_location;
                document.getElementById("modal-chapel").textContent =
                    data.chapel;
                document.getElementById("modal-opening-time").textContent =
                    data.opening_time;
                document.getElementById("modal-order-date").textContent =
                    data.order_date;
                loader.style.display = "none";
                content.style.display = "block";
            } catch (error) {
                loader.innerHTML = `<p class="text-danger">${error.message}</p>`;
            }
        }

        function updateColumnTitle(columnId, change) {
            const columnTitle = document.querySelector(
                `#${columnId} .column-title`,
            );
            if (columnTitle) {
                const text = columnTitle.innerText;
                const match = text.match(/\((\d+)\)/);
                if (match) {
                    const currentCount = parseInt(match[1], 10);
                    const newCount = Math.max(0, currentCount + change);
                    columnTitle.innerText = text.replace(
                        `(${currentCount})`,
                        `(${newCount})`,
                    );
                }
            }
        }

        function updateTimers() {
            document
                .querySelectorAll(".order-timer:not(.final-status)")
                .forEach((timerEl) => {
                    const orderDateStr = timerEl.dataset.orderDate;
                    if (!orderDateStr) return;
                    const orderTime = new Date(orderDateStr).getTime();
                    const deadline = orderTime + 90 * 60 * 1000;
                    const now = new Date().getTime();
                    const distance = deadline - now;
                    const timerSpan = timerEl.querySelector("span");
                    if (!timerSpan) return;
                    if (distance < 0) {
                        timerSpan.textContent = "Atrasado";
                        timerEl.style.color = "var(--error-color)";
                        return;
                    }
                    const hours = Math.floor(distance / (1000 * 60 * 60));
                    const minutes = Math.floor(
                        (distance % (1000 * 60 * 60)) / (1000 * 60),
                    );
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timerSpan.textContent = [hours, minutes, seconds]
                        .map((u) => (u < 10 ? "0" + u : u))
                        .join(":");
                    timerEl.style.color =
                        distance < 15 * 60 * 1000
                            ? "var(--warning-color)"
                            : "var(--success-color)";
                });
        }

        setInterval(updateTimers, 1000);
        updateTimers();

        document.body.addEventListener(
            "click",
            function unlockAudio() {
                if (audioUnlocked) return;
                notificationSound.play().catch(() => {});
                notificationSound.pause();
                notificationSound.currentTime = 0;
                audioUnlocked = true;
            },
            { once: true },
        );

        function getDragAfterElement(container, y) {
            const draggableElements = [
                ...container.querySelectorAll(".order-card:not(.dragging)"),
            ];
            return draggableElements.reduce(
                (closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset, element: child };
                    }
                    return closest;
                },
                { offset: Number.NEGATIVE_INFINITY },
            ).element;
        }

        function addOrderCardToBoard(order) {
            const columnBody = document.querySelector("#pending .column-body");
            if (!columnBody) return;
            const card = document.createElement("div");
            card.className = "order-card";
            card.draggable = true;
            card.dataset.orderId = order.id;
            card.style.animation = "fadeInDown 0.5s ease";

            card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="card-customer">${order.customer_name}</div>
                    <div class="card-product">${order.crown_name}</div>
                </div>
                <div class="dropdown"></div>
            </div>
            <div class="card-footer mt-3">
                <small>${order.order_date_formatted}</small>
                <div class="order-timer" data-order-date="${order.order_date_iso}"></div>
            </div>
        `;
            columnBody.prepend(card);
            updateCardContent(card, "pending");
            updateColumnTitle("pending", 1);
        }

        // Sistema de atualiza√ß√µes em tempo real usando WebSockets
        const socket = io();
        let isConnected = false;
        
        function initializeSocketIO() {
            // Eventos de conex√£o
            socket.on('connect', function() {
                isConnected = true;
                console.log('Conectado ao servidor WebSocket');
                showConnectionStatus('‚úì WebSocket conectado - tempo real ativo', 'success');
                
                // Entrar no room de admin
                socket.emit('join_admin');
            });
            
            socket.on('disconnect', function() {
                isConnected = false;
                console.log('Desconectado do servidor WebSocket');
                showConnectionStatus('‚ö†Ô∏è Conex√£o perdida - reconectando...', 'warning');
            });
            
            // Eventos de atualiza√ß√£o em tempo real
            socket.on('order_status_updated', function(data) {
                console.log('Status atualizado via WebSocket:', data);
                handleOrderStatusUpdate(data);
                playNotificationSound();
                showNotification(
                    `üìã ${data.customer_name}: ${getStatusText(data.old_status)} ‚Üí ${getStatusText(data.new_status)}`, 
                    'info'
                );
            });
            
            socket.on('order_deleted', function(data) {
                console.log('Pedido exclu√≠do via WebSocket:', data);
                handleOrderDeleted(data);
                playNotificationSound();
                showNotification(`üóëÔ∏è Pedido de ${data.customer_name} foi exclu√≠do`, 'warning');
            });
            
            socket.on('new_order_notification', function(data) {
                console.log('Novo pedido via WebSocket:', data);
                handleNewOrder(data);
                playNotificationSound();
                showNotification(`üÜï Novo pedido: ${data.customer_name} - ${data.crown_name}`, 'success');
            });
            
            socket.on('error', function(data) {
                console.error('Erro do WebSocket:', data);
                showNotification(`‚ùå Erro: ${data.message}`, 'danger');
            });
        }
        
        function handleOrderStatusUpdate(data) {
            // Encontrar o card do pedido
            const orderCard = document.querySelector(`[data-order-id="${data.order_id}"]`);
            if (orderCard) {
                // Mover o card para a coluna correta
                moveOrderCardToColumn(orderCard, data.new_status);
                
                // Adicionar efeito visual
                orderCard.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => {
                    orderCard.style.animation = '';
                }, 1000);
            }
            
            // Atualizar contadores das colunas
            updateAllColumnCounts();
        }
        
        function handleOrderDeleted(data) {
            const orderCard = document.querySelector(`[data-order-id="${data.order_id}"]`);
            if (orderCard) {
                // Anima√ß√£o de sa√≠da
                orderCard.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => {
                    orderCard.remove();
                    updateAllColumnCounts();
                }, 500);
            }
        }
        
        function handleNewOrder(data) {
            // Adicionar novo card na coluna "pending"
            const pendingColumn = document.querySelector('#pending .column-body');
            if (pendingColumn) {
                // Criar novo card de pedido
                const newCard = createOrderCard(data);
                pendingColumn.insertBefore(newCard, pendingColumn.firstChild);
                
                // Anima√ß√£o de entrada
                newCard.style.animation = 'fadeInDown 0.5s ease-in';
                
                updateAllColumnCounts();
            }
        }
        
        function moveOrderCardToColumn(orderCard, newStatus) {
            const targetColumn = document.querySelector(`#${newStatus} .column-body`);
            if (targetColumn && orderCard) {
                targetColumn.appendChild(orderCard);
            }
        }
        
        function createOrderCard(orderData) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.draggable = true;
            card.setAttribute('data-order-id', orderData.order_id);
            
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="card-customer">${orderData.customer_name}</div>
                        <div class="card-product">${orderData.crown_name}</div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li>
                                <button class="dropdown-item btn-view-details" data-order-id="${orderData.order_id}">
                                    <i class="fas fa-eye me-2"></i>Ver Detalhes
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-footer mt-3">
                    <small>Agora</small>
                    <div class="order-timer">
                        <i class="fas fa-clock"></i> <span>00:00:00</span>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function updateAllColumnCounts() {
            // Atualizar contadores de todas as colunas
            ['pending', 'in_progress', 'delivered'].forEach(status => {
                const column = document.getElementById(status);
                if (column) {
                    const cards = column.querySelectorAll('.order-card');
                    const count = cards.length;
                    const title = column.querySelector('.column-title');
                    if (title) {
                        const text = title.textContent;
                        const newText = text.replace(/\(\d+\)/, `(${count})`);
                        title.innerHTML = title.innerHTML.replace(text, newText);
                    }
                }
            });
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pendente';
                case 'in_progress': return 'Em Andamento';
                case 'delivered': return 'Entregue';
                default: return status;
            }
        }
        
        function updateOrdersBoard(orders) {
            // Separar pedidos por status
            const pending = orders.filter(order => order.status === 'pending');
            const inProgress = orders.filter(order => order.status === 'in_progress');
            const delivered = orders.filter(order => order.status === 'delivered');
            
            // Atualizar contadores nas colunas
            updateColumnCount('pending', pending.length);
            updateColumnCount('in_progress', inProgress.length);
            updateColumnCount('delivered', delivered.length);
            
            // Detectar novos pedidos ou mudan√ßas de status
            detectOrderChanges(orders);
        }
        
        function updateColumnCount(status, count) {
            const column = document.getElementById(status);
            if (column) {
                const title = column.querySelector('.column-title');
                if (title) {
                    const text = title.textContent;
                    const newText = text.replace(/\(\d+\)/, `(${count})`);
                    title.innerHTML = title.innerHTML.replace(text, newText);
                }
            }
        }
        
        function detectOrderChanges(newOrders) {
            if (!lastOrdersData) return;
            
            // Verificar pedidos que mudaram de status
            newOrders.forEach(newOrder => {
                const oldOrder = lastOrdersData.find(old => old.id === newOrder.id);
                if (oldOrder && oldOrder.status !== newOrder.status) {
                    showOrderStatusChange(newOrder.customer_name, oldOrder.status, newOrder.status);
                }
            });
            
            // Verificar novos pedidos
            const newOrdersCount = newOrders.length - (lastOrdersData ? lastOrdersData.length : 0);
            if (newOrdersCount > 0) {
                showNotification(`üÜï ${newOrdersCount} novo(s) pedido(s)!`, 'success');
            }
        }
        
        function showOrderStatusChange(customerName, oldStatus, newStatus) {
            const statusNames = {
                'pending': 'Pendente',
                'in_progress': 'Em Andamento', 
                'delivered': 'Entregue'
            };
            
            showNotification(
                `üìã ${customerName}: ${statusNames[oldStatus]} ‚Üí ${statusNames[newStatus]}`, 
                'info'
            );
        }
        
        function playNotificationSound() {
            const sound = document.getElementById('notification-sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('Som n√£o p√¥de ser reproduzido:', e));
            }
        }
        
        function showNotification(message, type = 'info') {
            // Remover notifica√ß√µes anteriores
            const existingNotifications = document.querySelectorAll('.realtime-notification');
            existingNotifications.forEach(n => n.remove());
            
            // Criar nova notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} realtime-notification position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 320px; opacity: 0; transition: opacity 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.2);';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'}"></i>
                    </div>
                    <div class="flex-grow-1">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Mostrar com anima√ß√£o
            setTimeout(() => notification.style.opacity = '1', 100);
            
            // Auto-remover ap√≥s 4 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function showConnectionStatus(message, type) {
            const statusEl = document.createElement('div');
            statusEl.className = `badge bg-${type} position-fixed`;
            statusEl.style.cssText = 'top: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 8px 16px;';
            statusEl.innerHTML = `<i class="fas fa-wifi me-2"></i>${message}`;
            
            document.body.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => statusEl.remove(), 300);
            }, 3000);
        }
        
        // Inicializar WebSocket
        initializeSocketIO();
    });
</script>
{% endblock %}
