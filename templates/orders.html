{% extends "base.html" %} {% block title %}Gestor de Pedidos{% endblock %} 

{% block scripts %}
<!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
{{ super() }}
{% endblock %}

{% block content %}
<audio
    id="notification-sound"
    src="{{ url_for('static', filename='audio/notification.mp3') }}"
    preload="auto"
></audio>

<div class="admin-header">
    <div class="container">
        <h1><i class="fas fa-tasks me-2"></i>Gestor de Pedidos</h1>
        <p>Arraste e solte os pedidos ou use o menu para atualizar o status.</p>
    </div>
</div>

<div class="container-fluid my-4">
    <div class="order-board">
        <div class="order-column" id="pending" data-status="pending">
            <h5 class="column-title">
                <i class="fas fa-inbox me-2"></i>A Fazer ({{ pending|length }})
            </h5>
            <div class="column-body">
                {% for order in pending %}
                <div
                    class="order-card"
                    draggable="true"
                    data-order-id="{{ order.id }}"
                >
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <div class="card-customer">
                                {{ order.customer_name }}
                            </div>
                            <div class="card-product">
                                {{ order.crown_name }}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button
                                class="btn btn-sm btn-icon"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li>
                                    <button
                                        class="dropdown-item btn-view-details"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailsModal"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-eye me-2"></i>Ver
                                        Detalhes
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="in_progress"
                                    >
                                        <i class="fas fa-arrow-right me-2"></i
                                        >Avançar Etapa
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-cancel-order text-danger"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-trash-alt me-2"></i
                                        >Cancelar Pedido
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer mt-3">
                        <small>{{ order.order_date|localtime }}</small>
                        <div
                            class="order-timer"
                            data-order-date="{{ order.order_date.isoformat() }}Z"
                        >
                            <i class="fas fa-clock"></i> <span>--:--:--</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="order-column" id="in_progress" data-status="in_progress">
            <h5 class="column-title">
                <i class="fas fa-sync-alt me-2"></i>Em Andamento ({{
                in_progress|length }})
            </h5>
            <div class="column-body">
                {% for order in in_progress %}
                <div
                    class="order-card"
                    draggable="true"
                    data-order-id="{{ order.id }}"
                >
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <div class="card-customer">
                                {{ order.customer_name }}
                            </div>
                            <div class="card-product">
                                {{ order.crown_name }}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button
                                class="btn btn-sm btn-icon"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li>
                                    <button
                                        class="dropdown-item btn-view-details"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailsModal"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-eye me-2"></i>Ver
                                        Detalhes
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="pending"
                                    >
                                        <i class="fas fa-arrow-left me-2"></i
                                        >Retroceder Etapa
                                    </button>
                                </li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="delivered"
                                    >
                                        <i class="fas fa-arrow-right me-2"></i
                                        >Avançar Etapa
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-cancel-order text-danger"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-trash-alt me-2"></i
                                        >Cancelar Pedido
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer mt-3">
                        <small>{{ order.order_date|localtime }}</small>
                        <div
                            class="order-timer"
                            data-order-date="{{ order.order_date.isoformat() }}Z"
                        >
                            <i class="fas fa-clock"></i> <span>--:--:--</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="order-column" id="delivered" data-status="delivered">
            <h5 class="column-title">
                <i class="fas fa-check-circle me-2"></i>Entregues ({{
                delivered|length }})
            </h5>
            <div class="column-body">
                {% for order in delivered %}
                <div
                    class="order-card"
                    draggable="true"
                    data-order-id="{{ order.id }}"
                >
                    <div
                        class="d-flex justify-content-between align-items-start"
                    >
                        <div>
                            <div class="card-customer">
                                {{ order.customer_name }}
                            </div>
                            <div class="card-product">
                                {{ order.crown_name }}
                            </div>
                        </div>
                        <div class="dropdown">
                            <button
                                class="btn btn-sm btn-icon"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li>
                                    <button
                                        class="dropdown-item btn-view-details"
                                        data-bs-toggle="modal"
                                        data-bs-target="#orderDetailsModal"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-eye me-2"></i>Ver
                                        Detalhes
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-change-status"
                                        data-next-status="in_progress"
                                    >
                                        <i class="fas fa-arrow-left me-2"></i
                                        >Retroceder Etapa
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <button
                                        class="dropdown-item btn-cancel-order text-danger"
                                        data-order-id="{{ order.id }}"
                                    >
                                        <i class="fas fa-trash-alt me-2"></i
                                        >Cancelar Pedido
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer mt-3">
                        <small>{{ order.order_date|localtime }}</small>
                        <div class="order-timer final-status">
                            <i class="fas fa-check-double"></i>
                            <span>Concluído</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Detalhes do Pedido
                    <span
                        id="modal-order-id"
                        class="text-primary fw-bold"
                    ></span>
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <div id="modal-loader" class="text-center p-5">
                    <div
                        class="spinner-border text-primary"
                        role="status"
                    ></div>
                </div>
                <div id="modal-content-details" style="display: none">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6><i class="fas fa-user me-2"></i>Cliente</h6>
                            <p class="mb-1">
                                <strong>Nome:</strong>
                                <span id="modal-customer-name"></span>
                            </p>
                            <p class="mb-1">
                                <strong>Telefone:</strong>
                                <span id="modal-customer-phone"></span>
                            </p>
                            <p class="mb-0">
                                <strong>Email:</strong>
                                <span id="modal-customer-email"></span>
                            </p>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h6>
                                <i class="fas fa-shopping-cart me-2"></i>Pedido
                            </h6>
                            <p class="mb-1">
                                <strong>Produto:</strong>
                                <span id="modal-crown-name"></span>
                            </p>
                            <p class="mb-0">
                                <strong>Valor Total:</strong>
                                <span id="modal-total-amount"></span>
                            </p>
                        </div>
                    </div>
                    <hr />
                    <div class="mb-4">
                        <h6><i class="fas fa-cross me-2"></i>Homenagem</h6>
                        <p class="mb-1">
                            <strong>Ente Querido:</strong>
                            <span id="modal-deceased-name"></span>
                        </p>
                        <p class="mb-1">
                            <strong>Mensagem na Faixa:</strong>
                            <span
                                id="modal-custom-message"
                                style="white-space: pre-wrap"
                            ></span>
                        </p>
                    </div>
                    <hr />
                    <div>
                        <h6>
                            <i class="fas fa-map-marker-alt me-2"></i>Entrega
                        </h6>
                        <p class="mb-1">
                            <strong>Local:</strong>
                            <span id="modal-delivery-location"></span>
                        </p>
                        <p class="mb-1">
                            <strong>Capela:</strong>
                            <span id="modal-chapel"></span>
                        </p>
                        <p class="mb-0">
                            <strong>Abertura do Velório:</strong>
                            <span id="modal-opening-time"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <small class="text-muted"
                    >Pedido realizado em:
                    <span id="modal-order-date"></span></small
                ><button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Sistema de atualizações em tempo real usando WebSockets
        const socket = io();
        let isConnected = false;
        
        function initializeSocketIO() {
            // Eventos de conexão
            socket.on('connect', function() {
                isConnected = true;
                console.log('Conectado ao servidor WebSocket');
                showConnectionStatus('✓ WebSocket conectado - tempo real ativo', 'success');
                
                // Entrar no room de admin
                socket.emit('join_admin');
            });
            
            socket.on('disconnect', function() {
                isConnected = false;
                console.log('Desconectado do servidor WebSocket');
                showConnectionStatus('⚠️ Conexão perdida - reconectando...', 'warning');
            });
            
            // Eventos de atualização em tempo real
            socket.on('order_status_updated', function(data) {
                console.log('Status atualizado via WebSocket:', data);
                handleOrderStatusUpdate(data);
                playNotificationSound();
                showNotification(
                    `📋 ${data.customer_name}: ${getStatusText(data.old_status)} → ${getStatusText(data.new_status)}`, 
                    'info'
                );
            });
            
            socket.on('order_deleted', function(data) {
                console.log('Pedido excluído via WebSocket:', data);
                handleOrderDeleted(data);
                playNotificationSound();
                showNotification(`🗑️ Pedido de ${data.customer_name} foi excluído`, 'warning');
            });
            
            socket.on('new_order_notification', function(data) {
                console.log('Novo pedido via WebSocket:', data);
                handleNewOrder(data);
                playNotificationSound();
                showNotification(`🆕 Novo pedido: ${data.customer_name} - ${data.crown_name}`, 'success');
            });
            
            socket.on('error', function(data) {
                console.error('Erro do WebSocket:', data);
                showNotification(`❌ Erro: ${data.message}`, 'danger');
            });
        }
        
        function handleOrderStatusUpdate(data) {
            // Encontrar o card do pedido
            const orderCard = document.querySelector(`[data-order-id="${data.order_id}"]`);
            if (orderCard) {
                // Mover o card para a coluna correta
                moveOrderCardToColumn(orderCard, data.new_status);
                
                // Adicionar efeito visual
                orderCard.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => {
                    orderCard.style.animation = '';
                }, 1000);
            }
            
            // Atualizar contadores das colunas
            updateAllColumnCounts();
        }
        
        function handleOrderDeleted(data) {
            const orderCard = document.querySelector(`[data-order-id="${data.order_id}"]`);
            if (orderCard) {
                // Animação de saída
                orderCard.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => {
                    orderCard.remove();
                    updateAllColumnCounts();
                }, 500);
            }
        }
        
        function handleNewOrder(data) {
            // Adicionar novo card na coluna "pending"
            const pendingColumn = document.querySelector('#pending .column-body');
            if (pendingColumn) {
                // Criar novo card de pedido
                const newCard = createOrderCard(data);
                pendingColumn.insertBefore(newCard, pendingColumn.firstChild);
                
                // Animação de entrada
                newCard.style.animation = 'fadeInDown 0.5s ease-in';
                
                updateAllColumnCounts();
            }
        }
        
        function moveOrderCardToColumn(orderCard, newStatus) {
            const targetColumn = document.querySelector(`#${newStatus} .column-body`);
            if (targetColumn && orderCard) {
                targetColumn.appendChild(orderCard);
            }
        }
        
        function createOrderCard(orderData) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.draggable = true;
            card.setAttribute('data-order-id', orderData.order_id);
            
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="card-customer">${orderData.customer_name}</div>
                        <div class="card-product">${orderData.crown_name}</div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li>
                                <button class="dropdown-item btn-view-details" data-order-id="${orderData.order_id}">
                                    <i class="fas fa-eye me-2"></i>Ver Detalhes
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-footer mt-3">
                    <small>Agora</small>
                    <div class="order-timer">
                        <i class="fas fa-clock"></i> <span>00:00:00</span>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function updateAllColumnCounts() {
            // Atualizar contadores de todas as colunas
            ['pending', 'in_progress', 'delivered'].forEach(status => {
                const column = document.getElementById(status);
                if (column) {
                    const cards = column.querySelectorAll('.order-card');
                    const count = cards.length;
                    const title = column.querySelector('.column-title');
                    if (title) {
                        const text = title.textContent;
                        const newText = text.replace(/\(\d+\)/, `(${count})`);
                        title.innerHTML = title.innerHTML.replace(text, newText);
                    }
                }
            });
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Pendente';
                case 'in_progress': return 'Em Andamento';
                case 'delivered': return 'Entregue';
                default: return status;
            }
        }
        
        function playNotificationSound() {
            const sound = document.getElementById('notification-sound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('Som não pôde ser reproduzido:', e));
            }
        }
        
        function showNotification(message, type = 'info') {
            // Remover notificações anteriores
            const existingNotifications = document.querySelectorAll('.realtime-notification');
            existingNotifications.forEach(n => n.remove());
            
            // Criar nova notificação
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} realtime-notification position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 320px; opacity: 0; transition: opacity 0.3s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.2);';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'}"></i>
                    </div>
                    <div class="flex-grow-1">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Mostrar com animação
            setTimeout(() => notification.style.opacity = '1', 100);
            
            // Auto-remover após 4 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function showConnectionStatus(message, type) {
            const statusEl = document.createElement('div');
            statusEl.className = `badge bg-${type} position-fixed`;
            statusEl.style.cssText = 'top: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 8px 16px;';
            statusEl.innerHTML = `<i class="fas fa-wifi me-2"></i>${message}`;
            
            document.body.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => statusEl.remove(), 300);
            }, 3000);
        }
        
        // Inicializar WebSocket
        initializeSocketIO();
    });
</script>
{% endblock %}
            const sourceColumn = card.closest(".order-column");
            const targetColumn = document.getElementById(newStatus);
            if (!targetColumn || !sourceColumn || sourceColumn.id === newStatus)
